#!/usr/bin/env bash
# Borrowed from the s2n-bignum project
# https://github.com/awslabs/s2n-bignum/blob/main/arm/proofs/simulator.c
# Author(s): John Harrison, Juneyoung Lee

cd Arm/Insts/Cosim

OUTFILE=$(mktemp)

echo "Writing asm to: '${OUTFILE}.S'. Executable to: '${OUTFILE}.out'." >&2

cat template.S | sed -e "s/ICODE/$1/" > "${OUTFILE}.S"
gcc -c "${OUTFILE}.S"  -o "${OUTFILE}.o"
gcc -o "${OUTFILE}.out" simulator.c "${OUTFILE}.o"

shift 1
"${OUTFILE}.out" "$@"

#### rm "${OUTFILE}.out" "${OUTFILE}.S" "${OUTFILE}.o"

####  rm *.o simulator
